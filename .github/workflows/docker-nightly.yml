name: Nightly Docker

on:
  schedule:
    - cron: "0 0 */2 * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for recent changes
        id: git_log
        run: |
          if [ -z "$(git log --since='2 days ago')" ]; then
            echo "No recent changes found in the last 2 days. Skipping build."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Recent changes found. Proceeding with build."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Get lockfile hashes
        if: steps.git_log.outputs.changed == 'true'
        id: lockfile_hash
        run: |
          echo "cargo_lock_hash=$(sha256sum backend/Cargo.lock | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "pnpm_lock_hash=$(sha256sum frontend/pnpm-lock.yaml | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Cache backend target directory
        if: steps.git_log.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: backend/target
          key: backend-target-${{ runner.os }}-${{ steps.lockfile_hash.outputs.cargo_lock_hash }}
          restore-keys: |
            backend-target-${{ runner.os }}-

      - name: Cache frontend node_modules
        if: steps.git_log.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ runner.os }}-${{ steps.lockfile_hash.outputs.pnpm_lock_hash }}
          restore-keys: |
            frontend-node-modules-${{ runner.os }}-

      - name: Cache frontend .svelte-kit
        if: steps.git_log.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: frontend/.svelte-kit
          key: frontend-svelte-kit-${{ runner.os }}-${{ steps.lockfile_hash.outputs.pnpm_lock_hash }}
          restore-keys: |
            frontend-svelte-kit-${{ runner.os }}-

      - name: Install Rust toolchain
        if: steps.git_log.outputs.changed == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl,aarch64-unknown-linux-musl

      - name: Setup musl-tools
        if: steps.git_log.outputs.changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config make perl

      - uses: pnpm/action-setup@v4
        if: steps.git_log.outputs.changed == 'true'
        name: Install pnpm
        with:
          version: 10
          run_install: false
          package_json_file: "./frontend/package.json"

      - name: Setup Node.js
        if: steps.git_log.outputs.changed == 'true'
        uses: actions/setup-node@v5
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: ./frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        if: steps.git_log.outputs.changed == 'true'
        working-directory: ./frontend
        run: pnpm install

      - name: Install Zig
        if: steps.git_log.outputs.changed == 'true'
        uses: mlugg/setup-zig@v2
        with:
          version: "0.13.0"

      - name: Cache cargo binaries
        if: steps.git_log.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-${{ runner.os }}-cargo-zigbuild
          restore-keys: |
            cargo-bin-${{ runner.os }}-

      - name: Install cargo-zigbuild
        if: steps.git_log.outputs.changed == 'true'
        run: |
          if ! command -v cargo-zigbuild &> /dev/null; then
            cargo install --locked cargo-zigbuild
          fi

      - name: Make build script executable
        if: steps.git_log.outputs.changed == 'true'
        run: chmod +x package/build-docker-artifacts.sh

      - name: Build artifacts outside Docker
        if: steps.git_log.outputs.changed == 'true'
        run: ./package/build-docker-artifacts.sh

      - name: Set up Docker Buildx
        if: steps.git_log.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.git_log.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.git_log.outputs.changed == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/pinkfuwa/llumen
          tags: type=raw,value=nightly

      - name: Build and push nightly image
        if: steps.git_log.outputs.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./package/Dockerfile.nightly
          platforms: "linux/amd64,linux/arm64"
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
